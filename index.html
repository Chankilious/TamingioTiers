<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Taming.io Dagger 1v1 Tiers</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg:#0e0e11; --card:#17171d; --text:#e6e6eb; --muted:#9a9aa5;
      --gold:#ffd700; --silver:#cfd8dc; --bronze:#cd7f32;
      --eu:#3bff7a; --na:#ff4b4b; --as:#4bd9ff; --danger:#ff6b6b; --ok:#6bff9a;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text);padding:24px}
    h1{text-align:center;margin-bottom:6px}
    .subtitle{text-align:center;color:var(--muted);margin-bottom:36px}

    .info-wrapper{display:grid;grid-template-columns:1fr 1fr;gap:32px;max-width:1150px;margin:0 auto 64px}
    .box{background:var(--card);padding:22px;border-radius:16px}
    .box h3{margin-top:0;margin-bottom:14px}
    .box ul{padding-left:18px}
    .box li{margin-bottom:10px;line-height:1.6}

    .tiers-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
    .tier-pair{border-bottom:1px solid rgba(255,255,255,.08);padding-bottom:12px}

    .form-wrap{max-width:800px;margin:0 auto 72px}
    .form-wrap h2{text-align:center;margin-bottom:14px}
    form{background:var(--card);padding:22px;border-radius:16px}
    label{display:block;margin-bottom:6px;color:var(--muted)}
    input,select{width:100%;padding:12px 14px;margin-bottom:16px;border-radius:12px;border:none;background:#1f1f27;color:var(--text)}
    .row-flex{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    button{width:100%;padding:12px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--gold),#ffea80);font-weight:800;cursor:pointer}
    .btn-danger{background:linear-gradient(90deg,var(--danger),#ff9b9b)}
    .btn-ok{background:linear-gradient(90deg,var(--ok),#b8ffd8)}
    .error{color:var(--danger);font-size:14px;margin-bottom:10px}
    .success{color:var(--ok);font-size:14px;margin-bottom:10px}

    .search-wrap{max-width:900px;margin:0 auto 24px}
    .search-wrap input{width:100%;padding:12px 14px;border-radius:12px;border:none;background:#1f1f27;color:var(--text)}

    .leaderboard{background:var(--card);border-radius:16px;overflow:hidden}
    .leaderboard h2{text-align:center;margin:0;padding:14px;background:#1f1f27}
    .header,.row{display:grid;grid-template-columns:60px 70px 1fr 140px 110px;align-items:center;padding:12px 18px}
    .header{font-size:13px;color:var(--muted);border-bottom:1px solid rgba(255,255,255,.08)}
    .row{border-top:1px solid rgba(255,255,255,.05);cursor:pointer}
    .row.top1{background:rgba(255,215,0,.08)}
    .row.top2{background:rgba(207,216,220,.08)}
    .row.top3{background:rgba(205,127,50,.08)}
    .pos{text-align:center;font-weight:700}
    .avatar{width:52px;height:52px;border-radius:12px;object-fit:cover;background:#222}
    .name{font-weight:600}
    .tier{text-align:center;font-weight:800}
    .region-tag{padding:4px 12px;border-radius:999px;font-weight:700;font-size:13px;text-align:center;margin:auto}
    .EU{border:2px solid var(--eu);color:var(--eu)}
    .NA{border:2px solid var(--na);color:var(--na)}
    .AS{border:2px solid var(--as);color:var(--as)}
    .crown{margin-left:6px;filter:drop-shadow(0 0 6px var(--gold));animation:glow 2s infinite alternate}
    @keyframes glow{to{filter:drop-shadow(0 0 14px var(--gold))}}

    .global-wrapper{max-width:1050px;margin:0 auto 96px}
    .regional-wrapper{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:36px;max-width:1350px;margin:0 auto}

    footer{text-align:center;margin-top:72px;color:var(--muted);font-size:14px}

    /* Login style */
    #login {
      max-width:400px;
      margin:0 auto 24px;
      background:var(--card);
      padding:18px;
      border-radius:16px;
      text-align:center;
    }
    #login input { margin-bottom:10px; }

    /* red glow for wrong login */
    .errorGlow {
      animation: glow 1s infinite alternate;
      border: 2px solid var(--danger);
    }
  </style>
</head>
<body>

<h1>Taming.io â€“ Dagger 1v1</h1>
<div class="subtitle">Official Community Leaderboards</div>

<!-- LOGIN -->
<div id="login">
  <h3>Admin Login</h3>
  <input id="loginEmail" placeholder="Email" />
  <input id="loginPass" type="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <div id="loginMsg"></div>
</div>

<div class="info-wrapper">
  <div class="box">
    <h3>Rules</h3>
    <ul>
      <li>Dagger 1v1 only â€¢ First to 5 points</li>
      <li>Shield usage must be agreed before the fight</li>
      <li>For global testing, both players must play <strong>5 rounds in each playerâ€™s main region</strong></li>
      <li><strong>Tier requirement:</strong> players must be tier tested by a verified <strong>HT3 tester</strong>. To obtain a tier, you must defeat a player already holding that tier.</li>
    </ul>
  </div>
  <div class="box">
    <h3>Tiers</h3>
    <div class="tiers-grid">
      <div class="tier-pair"><strong>HT1</strong><br>Best player overall</div>
      <div class="tier-pair"><strong>LT1</strong></div>
      <div class="tier-pair"><strong>HT2</strong></div>
      <div class="tier-pair"><strong>LT2</strong></div>
      <div class="tier-pair"><strong>HT3</strong><br>Tier testers</div>
      <div class="tier-pair"><strong>LT3</strong></div>
      <div class="tier-pair"><strong>HT4</strong></div>
      <div class="tier-pair"><strong>LT4</strong></div>
      <div class="tier-pair"><strong>HT5</strong></div>
      <div class="tier-pair"><strong>LT5</strong><br>Untested</div>
    </div>
  </div>
</div>

<div class="form-wrap">
  <h2>Tier Test Submission</h2>
  <form id="submitForm">
    <div id="formMsg"></div>
    <label>Player Name</label>
    <input id="fname" required minlength="2" maxlength="24" />
    <div class="row-flex">
      <div>
        <label>Taming.io ID (numbers only)</label>
        <input id="fid" required pattern="\d+" />
      </div>
      <div>
        <label>Main Region</label>
        <select id="fregion" required>
          <option value="">Select region</option>
          <option>EU</option><option>NA</option><option>AS</option>
        </select>
      </div>
    </div>
    <button type="submit">Submit for Approval</button>
  </form>
</div>

<div class="search-wrap"><input id="search" placeholder="Search players..."></div>
<div class="global-wrapper" id="global"></div>
<div class="regional-wrapper" id="regional"></div>

<footer>Not affiliated with taming.io â€¢ Rankings decided by certified tier testers</footer>

<script>
  // ================= SUPABASE SETUP =================
  const SUPABASE_URL = "https://mnwathdxbguxmmbyirsu.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ud2F0aGR4Ymd1eG1t9lXQpg7ImgGrrdPzwFOGF7Byiq4";

  const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const tierOrder=['HT1','LT1','HT2','LT2','HT3','LT3','HT4','LT4','HT5','LT5'];

  // ================= LOAD PLAYERS =================
  async function loadPlayers(){
    const { data, error } = await supabase.from('players').select('*');
    if(error){console.error(error);return;}
    renderLeaderboards(data);
  }

  // ================= RENDER =================
  function build(title,list,showRegion){
    const b=document.createElement('div');b.className='leaderboard';
    b.innerHTML=`<h2>${title}</h2><div class="header"><div>#</div><div></div><div>Player</div>${showRegion?'<div>Region</div>':''}<div>Tier</div></div>`;
    list.forEach((p,i)=>{
      const r=document.createElement('div');
      r.className='row '+(i===0?'top1':i===1?'top2':i===2?'top3':'');

      const avatar = p.skin_url || '';
      r.innerHTML=`<div class="pos">${i+1}</div>
                   <img class="avatar" src="${avatar}">
                   <div class="name">${p.name}${title.includes('GLOBAL')&&i===0?' <span class="crown">ðŸ‘‘</span>':''}</div>
                   ${showRegion?`<div><span class="region-tag ${p.region}">${p.region}</span></div>`:''}
                   <div class="tier">${p.tier}</div>`;
      b.appendChild(r);
    });
    return b;
  }

  function renderLeaderboards(players){
    global.innerHTML='';
    regional.innerHTML='';

    const sorted=[...players].sort((a,b)=>tierOrder.indexOf(a.tier)-tierOrder.indexOf(b.tier));
    global.appendChild(build('ðŸŒ GLOBAL LEADERBOARD',sorted,true));
    ['EU','NA','AS'].forEach(r=>regional.appendChild(build(`${r} Leaderboard`,players.filter(p=>p.region===r),false)));
  }

  // ================= SUBMIT =================
  document.getElementById('submitForm').onsubmit = async (e)=>{
    e.preventDefault();
    const name=fname.value.trim();
    const id=fid.value.trim();
    const region=fregion.value;
    formMsg.innerHTML='';

    if(!/^[0-9]+$/.test(id)){
      formMsg.innerHTML='<div class="error">ID must be numbers only.</div>';
      return;
    }

    const { error } = await supabase.from('pending_submissions').insert({
      name,
      taming_id:id,
      region
    });

    if(error){
      formMsg.innerHTML='<div class="error">You have already submitted or an error occurred.</div>';
    } else {
      formMsg.innerHTML='<div class="success">Submission received. Await approval.</div>';
      e.target.reset();
    }
  };

  // ================= SEARCH =================
  document.getElementById("search").oninput = ()=>{
    const q = document.getElementById("search").value.toLowerCase();
    document.querySelectorAll('.row').forEach(r=>{
      r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
    });
  };

  loadPlayers();

  // ================= ADMIN LOGIN =================
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");

  loginBtn.addEventListener("click", async () => {
    loginMsg.innerHTML = "";
    loginBtn.classList.remove("errorGlow");

    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPass").value;

    const { error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      loginMsg.innerHTML = '<div class="error">Login failed</div>';
      loginBtn.classList.add("errorGlow");
      return;
    }

    // verify admin
    const { data: user } = await supabase.auth.getUser();
    const { data: admin } = await supabase.from('admins').select('*').eq('user_id', user.user.id).single();

    if (!admin) {
      loginMsg.innerHTML = '<div class="error">Not an admin</div>';
      await supabase.auth.signOut();
      loginBtn.classList.add("errorGlow");
      return;
    }

    loginMsg.innerHTML = '<div class="success">Logged in as admin!</div>';
    document.getElementById("login").style.display = "none";
    showAdminPanel();
  });

  // ================= ADMIN PANEL (DYNAMIC) =================
  function showAdminPanel() {
    const panel = document.createElement("div");
    panel.id = "adminPanel";
    panel.style = "position:fixed;top:0;right:0;width:360px;height:100%;background:#0f0f14;border-left:2px solid #222;padding:12px;overflow-y:auto;z-index:9999";

    panel.innerHTML = `
      <h2 style="color:#fff">Admin Panel</h2>
      <button onclick="logoutAdmin()">Logout</button>
      <hr>
      <h3>Pending Submissions</h3>
      <div id="pendingList"></div>
      <hr>
      <h3>Add / Edit Player</h3>
      <input id="ap_name" placeholder="Player name">
      <input id="ap_id" placeholder="Taming ID (numbers)">
      <input id="ap_region" placeholder="Region (EU / NA / AS)">
      <input id="ap_tier" placeholder="Tier (HT1, LT2, etc)">
      <input id="ap_skin" placeholder="Skin image URL">
      <button onclick="savePlayer()">Save Player</button>
      <hr>
      <h3>Players</h3>
      <div id="adminPlayers"></div>
    `;

    document.body.appendChild(panel);
    loadPending();
    loadAdminPlayers();
  }

  async function logoutAdmin(){
    await supabase.auth.signOut();
    window.location.reload();
  }

  async function loadPending() {
    const { data } = await supabase.from('pending_submissions').select('*');
    const box = document.getElementById('pendingList');
    box.innerHTML = '';
    data.forEach(p => {
      const div = document.createElement('div');
      div.innerHTML = `${p.name} (${p.taming_id}) <button onclick="approve('${p.id}')">Approve</button> <button onclick="reject('${p.id}')">Reject</button>`;
      box.appendChild(div);
    });
  }

  async function approve(id) {
    const { data } = await supabase.from('pending_submissions').select('*').eq('id', id).single();
    await supabase.from('players').insert({
      name: data.name,
      taming_id: data.taming_id,
      tier: 'LT5',
      region: data.region || 'EU'
    });
    await supabase.from('pending_submissions').delete().eq('id', id);
    loadPending();
    loadPlayers();
  }

  async function reject(id) {
    await supabase.from('pending_submissions').delete().eq('id', id);
    loadPending();
  }

  async function savePlayer() {
    const name = ap_name.value;
    const tid = ap_id.value;
    const region = ap_region.value;
    const tier = ap_tier.value;
    const skin = ap_skin.value;

    await supabase.from('players').upsert({
      name,
      taming_id: tid,
      region,
      tier,
      skin_url: skin
    }, { onConflict: 'taming_id' });

    loadPlayers();
    loadAdminPlayers();
  }

  async function loadAdminPlayers() {
    const { data } = await supabase.from('players').select('*');
    const box = document.getElementById('adminPlayers');
    box.innerHTML = '';
    data.forEach(p => {
      const div = document.createElement('div');
      div.innerHTML = `${p.name} (${p.tier}) <button onclick="removePlayer('${p.taming_id}')">Delete</button>`;
      box.appendChild(div);
    });
  }

  async function removePlayer(id) {
    await supabase.from('players').delete().eq('taming_id', id);
    loadPlayers();
    loadAdminPlayers();
  }
</script>

</body>
</html>
